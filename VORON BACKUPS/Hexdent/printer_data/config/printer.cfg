[include mainsail.cfg]

#####################################################################
# 	MCU's
#####################################################################

# Manta M8P
[mcu]
canbus_uuid: bf156cd628f1

# Calamity EBB36
[mcu Calamity]
canbus_uuid: bc1259f5fe1d

# Monster8 v2
[mcu Z]
canbus_uuid: cefa10d37915

[mcu scanner]
canbus_uuid: e74eb98654dc

[printer]
kinematics: extended_corexy
max_velocity: 1200
max_accel: 20000
max_z_velocity: 20
max_z_accel: 350
square_corner_velocity: 5
home_y_axis_with_b_rail: True

;[adxl345]
;cs_pin: scanner:PA3
;spi_bus: spi1

[adxl345]
cs_pin: Calamity:PB12
spi_software_sclk_pin: Calamity:PB10
spi_software_mosi_pin: Calamity:PB11
spi_software_miso_pin: Calamity:PB2

[resonance_tester]
probe_points: 150, 172.5, 30
accel_chip: adxl345
accel_per_hz: 75

#[shaketune]
#number_of_results_to_keep: 10
#show_macros_in_webui: True
#timeout: 600

[input_shaper]
smoother_freq_x: 81.2
shaper_type_x: smooth_zv
smoother_freq_y: 87
shaper_type_y: smooth_mzv

[gcode_button ESTOP]
pin: ^PF3
press_gcode:
    {action_emergency_stop()}

[danger_options]
multi_mcu_trsync_timeout:   0.07
minimal_logging:            False
log_velocity_limit_changes: False
autosave_includes:          True

#####################################################################
# 	Temps
#####################################################################

[temperature_sensor MCU]
sensor_type: temperature_mcu

[temperature_sensor CM4]
sensor_type: temperature_host

[temperature_sensor Calamity]
sensor_type: temperature_mcu
sensor_mcu: Calamity
min_temp: 10
max_temp: 100

[temperature_sensor MCU_Z]
sensor_type: temperature_mcu
sensor_mcu: Z
min_temp: 10
max_temp: 100

[temperature_sensor Cartographer_MCU]
sensor_type: temperature_mcu
sensor_mcu: scanner
min_temp: 0
max_temp: 105

[temperature_sensor A0_Chube_CS]
sensor_type: Generic 3950
sensor_pin: Calamity:PA3
min_temp: -250
max_temp: 100

[temperature_sensor S1_Stepper_BR]
sensor_type: Generic 3950
sensor_pin: PB0
min_temp: 10
max_temp: 100

[temperature_sensor S2_Stepper_YR]
sensor_type: Generic 3950
sensor_pin: PC5
min_temp: 10
max_temp: 100

[temperature_sensor S4_Stepper_BL]
sensor_type: Generic 3950
sensor_pin: PC4
min_temp: 10
max_temp: 100

[temperature_sensor S5_Stepper_YL]
sensor_type: Generic 3950
sensor_pin: PA7
min_temp: 10
max_temp: 100

[temperature_sensor S3_Stepper_FR]
sensor_type: Generic 3950
sensor_pin: Z:PC0
min_temp: 10
max_temp: 100

[temperature_sensor S6_Stepper_FL]
sensor_type: Generic 3950
sensor_pin: Z:PC1
min_temp: 10
max_temp: 100

[temperature_sensor S7_Stepper_Average]
sensor_type: temperature_combined
sensor_list: temperature_sensor S1_Stepper_BR, temperature_sensor S2_Stepper_YR, temperature_sensor S4_Stepper_BL, temperature_sensor S5_Stepper_YL, temperature_sensor S3_Stepper_FR, temperature_sensor S6_Stepper_FL
combination_method: mean
maximum_deviation: 999.9

[temperature_sensor S0_Stepper_Max]
sensor_type: temperature_combined
sensor_list: temperature_sensor S1_Stepper_BR, temperature_sensor S2_Stepper_YR, temperature_sensor S4_Stepper_BL, temperature_sensor S5_Stepper_YL, temperature_sensor S3_Stepper_FR, temperature_sensor S6_Stepper_FL
combination_method: max
maximum_deviation: 999.9

#####################################################################
# 	X/Y Stepper Settings
#####################################################################

[motor_constants ldo-42sth60-3004ah]
resistance: 1.0
inductance: 0.0016
holding_torque: 0.8
max_current: 3.0
steps_per_revolution: 200

[stepper_a]
step_pin: PB8
dir_pin: PB7
enable_pin: !PE0
microsteps: 16
rotation_distance: 50
full_steps_per_rotation:200
endstop_pin: tmc5160_stepper_a:virtual_endstop
position_min: 0
position_endstop: 300
position_max: 300
homing_speed: 80
homing_accel: 3000
homing_retract_dist: 10
homing_positive_dir: True
use_sensorless_homing: True

[tmc5160 stepper_a]
cs_pin: PB9
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
diag1_pin: ^!PF2
interpolate: True
run_current: 2.5
home_current: 1.0
sense_resistor: 0.075
stealthchop_threshold: 0

[autotune_tmc stepper_a]
motor: ldo-42sth60-3004ah
tuning_goal: performance
voltage: 56
pwm_freq_target: 40e3
sg4_thrs: 80
sgt: 1

[stepper_a1]
step_pin: PB4
dir_pin: PB3
enable_pin: !PB6
microsteps: 16
rotation_distance: 50
full_steps_per_rotation:200

[tmc5160 stepper_a1]
cs_pin: PB5
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
interpolate: True
run_current: 2.5
home_current: 1.0
sense_resistor: 0.075
stealthchop_threshold: 0

[autotune_tmc stepper_a1]
motor: ldo-42sth60-3004ah
tuning_goal: performance
voltage: 56
pwm_freq_target: 40e3
sg4_thrs: 80

[stepper_b]
step_pin: PE6
dir_pin: PE5
enable_pin: !PC14
microsteps: 16
rotation_distance: 50
full_steps_per_rotation:200
endstop_pin: tmc5160_stepper_b:virtual_endstop
position_min: 0
position_endstop: 345
position_max: 345
homing_speed: 80
homing_accel: 3000
homing_retract_dist: 10
homing_positive_dir: True
use_sensorless_homing: True

[tmc5160 stepper_b]
cs_pin: PC13
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
diag1_pin: ^!PF4
interpolate: True
run_current: 2.5
home_current: 1.0
sense_resistor: 0.075
stealthchop_threshold: 0

[autotune_tmc stepper_b]
motor: ldo-42sth60-3004ah
tuning_goal: performance
voltage: 56
pwm_freq_target: 40e3
sg4_thrs: 80
sgt: 1

[stepper_b1]
step_pin: PE2
dir_pin: PE1
enable_pin: !PE4
microsteps: 16
rotation_distance: 50
full_steps_per_rotation:200

[tmc5160 stepper_b1]
cs_pin: PE3
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
interpolate: True
run_current: 2.5
home_current: 1.0
sense_resistor: 0.075
stealthchop_threshold: 0

[autotune_tmc stepper_b1]
motor: ldo-42sth60-3004ah
tuning_goal: performance
voltage: 56
pwm_freq_target: 40e3
sg4_thrs: 80

[stepper_c]
step_pin: PG13
dir_pin: PG12
enable_pin: !PG15
microsteps: 16
rotation_distance: 50
full_steps_per_rotation:200
position_endstop: 345
position_min: 0
position_max: 345
homing_speed: 80
homing_accel: 3000
homing_retract_dist: 0
endstop_pin: ^!PF1

[tmc5160 stepper_c]
cs_pin: PG14
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
interpolate: True
run_current: 2.0
home_current: 0.6
sense_resistor: 0.075
stealthchop_threshold: 0

[autotune_tmc stepper_c]
motor: ldo-42sth60-3004ah
tuning_goal: performance
voltage: 56
pwm_freq_target: 40e3
sg4_thrs: 80

[stepper_c1]
step_pin: PG9
dir_pin: !PD7
enable_pin: !PG11
microsteps: 16
rotation_distance: 50
full_steps_per_rotation:200
endstop_pin: ^!PF0

[tmc5160 stepper_c1]
cs_pin: PG10
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
interpolate: True
run_current: 2.0
home_current: 0.6
sense_resistor: 0.075
stealthchop_threshold: 0

[autotune_tmc stepper_c1]
motor: ldo-42sth60-3004ah
tuning_goal: performance
voltage: 56
pwm_freq_target: 40e3
sg4_thrs: 80

#####################################################################
# 	Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: Z:PC14
dir_pin: Z:PC13
enable_pin: !Z:PC15
rotation_distance: 4
microsteps: 16
endstop_pin: probe:z_virtual_endstop
position_max: 160
position_min: -8
homing_speed: 8.0
homing_retract_dist: 0

[tmc2209 stepper_z]
uart_pin: Z:PE6
interpolate: True
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]
step_pin: Z:PE1
dir_pin: Z:PE0
enable_pin: !Z:PE2
rotation_distance: 4
microsteps: 16

[tmc2209 stepper_z1]
uart_pin: Z:PB7
interpolate: True
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z2]
step_pin: Z:PB5
dir_pin: Z:PB4
enable_pin: !Z:PB6
rotation_distance: 4
microsteps: 16

[tmc2209 stepper_z2]
uart_pin: Z:PB3
interpolate: True
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

#####################################################################
# 	Bed Heater
#####################################################################

[heater_bed]
heater_pin: PA0
sensor_type: Generic 3950
sensor_pin: PB1
max_power: 1.0
min_temp: 0
max_temp: 150
pwm_cycle_time: 0.02088

[output_pin _bed_power]
pin: PA1
value: 0.0
shutdown_value: 0.0

[gcode_macro SET_HEATER_TEMPERATURE]
rename_existing: _SET_HEATER_TEMPERATURE
gcode:
    {% set HEATER = params.HEATER %}
    {% set TARGET = params.TARGET | default(0) | int %}
    
    {% if HEATER == "heater_bed" %}
        {% if TARGET > 0 %}
            SET_PIN PIN=_bed_power VALUE=1.0
        {% else %}
            SET_PIN PIN=_bed_power VALUE=0.0
        {% endif %}
    {% endif %}
    
    _SET_HEATER_TEMPERATURE HEATER={HEATER} TARGET={TARGET}

[gcode_macro TURN_OFF_HEATERS]
rename_existing: _TURN_OFF_HEATERS
gcode:
    SET_PIN PIN=_bed_power VALUE=0.0
    _TURN_OFF_HEATERS

#####################################################################
# 	Extruder
#####################################################################

#	E0 on Motor8
[extruder]
step_pin: Calamity:PD0
dir_pin: !Calamity:PD1
enable_pin: !Calamity:PD2
rotation_distance: 22.452161589
gear_ratio: 50:10
microsteps: 16
full_steps_per_rotation: 200
nozzle_diameter: 0.5
heater_pin: Calamity:PB13
sensor_type: MAX31865
sensor_pin: Calamity:PA4
spi_software_sclk_pin: Calamity:PA5
spi_software_mosi_pin: Calamity:PA7
spi_software_miso_pin: Calamity:PA6
rtd_nominal_r: 1000
rtd_reference_r: 4300
rtd_num_of_wires: 2
min_temp: 10
max_temp: 450
max_power: 1.0
min_extrude_temp: 170
pressure_advance: 0.014
pressure_advance_smooth_time: 0.03
max_extrude_cross_section: 5
max_extrude_only_distance: 100
# MPC FFF Settings
heater_power: 120
cooling_fan: fan
filament_diameter: 1.75
filament_density: 1.25
filament_heat_capacity: 2.0

[tmc2209 extruder]
uart_pin: Calamity:PA15
interpolate: false
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[autotune_tmc extruder]
motor: moons-cse14hra1l410a

#####################################################################
# 	Probe
#####################################################################

[scanner]
mcu: scanner
x_offset: 0
y_offset: 25
backlash_comp: 0.5
sensor: cartographer
sensor_alt: carto 
mesh_runs: 2

#####################################################################
# 	Fan Control
#####################################################################

[fan]
pin: Calamity:PD3
kick_start_time: 0.1
min_power: 0.15
cycle_time: 0.00005

[multi_pin Stepper_Fans]
pins: Z:PD5, Z:PD6, Z:PD7, PC7, PC8

[controller_fan Stepper_Fans]
pin: multi_pin:Stepper_Fans
max_power: 1.0
shutdown_speed: 1.0
kick_start_time: 0.5
min_power: 0.1
fan_speed: 1.0
idle_timeout: 240
idle_speed: 0.3
heater:

[multi_pin EC_Fans_Steppers]
pins: PD2, Z:PA0

[controller_fan EC_Fans_Steppers]
pin: multi_pin:EC_Fans_Steppers
max_power: 1.0
shutdown_speed: 1.0
kick_start_time: 0.5
min_power: 0.1
fan_speed: 0.5
idle_timeout: 60
idle_speed: 0.3
heater:

[multi_pin EC_Fans_Heaters]
pins: PA4, Z:PA1

[controller_fan EC_Fans_Heaters]
pin: multi_pin:EC_Fans_Heaters
max_power: 1.0
shutdown_speed: 1.0
kick_start_time: 0.5
min_power: 0.1
fan_speed: 0.5
idle_timeout: 60
idle_speed: 0.3
stepper:
heater: extruder, heater_bed

[multi_pin Stepper_Driver_Fans]
pins: PF9, PF6, PF8

[controller_fan Stepper_Driver_Fans]
pin: multi_pin:Stepper_Driver_Fans
max_power: 1.0
shutdown_speed: 1.0
kick_start_time: 0.5
min_power: 0.1
fan_speed: 1.0
idle_timeout: 60
idle_speed: 0.3
heater:

[temperature_fan MCU_fan]
sensor_type: temperature_host
pin: PF7
max_temp: 80.0
target_temp: 45.0
min_temp: 0
shutdown_speed: 1.0
kick_start_time: 0.5
min_power: 0.19
max_speed: 1.0
min_speed: 0.0
control: pid
pid_Kp: 2.0
pid_Ki: 5.0
pid_Kd: 0.5
pid_deriv_time: 2.0

[fan_generic bed_fans]
pin: Z:PA2
max_power: 1.0
min_power: 0.1
kick_start_time: 1.0
shutdown_speed: 1.0

#####################################################################
# 	LED Control
#####################################################################

[output_pin caselight]
pin: PA3
pwm:true
shutdown_value: 0
value: 1.0
cycle_time: 0.01

;[neopixel Calamity]
;pin: Calamity:PD3
;chain_count: 3
;color_order: GRBW

[neopixel BF]
pin: PD15
chain_count: 16
color_order: GRB

;[delayed_gcode boot]
;initial_duration: 1
;gcode:
;    SET_LED LED="Calamity" RED=1.0 GREEN=0.0 BLUE=0.0 WHITE=0.0 INDEX=1 SYNC=0 TRANSMIT=0
;    SET_LED LED="Calamity" RED=1.0 GREEN=1.0 BLUE=1.0 WHITE=1.0 INDEX=2 SYNC=0 TRANSMIT=0
;    SET_LED LED="Calamity" RED=1.0 GREEN=1.0 BLUE=1.0 WHITE=1.0 INDEX=3 SYNC=0 TRANSMIT=1

#####################################################################
# 	Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

[safe_z_home]
home_xy_position: 150, 172.5
speed: 1200
z_hop: 10

[z_tilt]
z_positions:
   -50, 18
   175, 398
   400, 18
points:
   10, 0
   150, 275
   290, 0
speed: 800
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0075

[gcode_macro Z_TILT_ADJUST]
rename_existing: _Z_TILT_ADJUST
gcode:
  _Z_TILT_ADJUST horizontal_move_z=10 retries=0 retry_tolerance=1.000
  _Z_TILT_ADJUST horizontal_move_z=3

[bed_mesh]
speed: 1200
horizontal_move_z: 10
mesh_min: 10, 30
mesh_max: 290,305
zero_reference_position: 150, 172.5
probe_count: 9, 9
algorithm: bicubic

[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
gcode:
    
    {% set scv   = printer.configfile.settings.printer.square_corner_velocity | int %}
    {% set accel = printer.configfile.settings.printer.max_accel              | int %}
       
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={accel / 1000}
    
    _BED_MESH_CALIBRATE {rawparams}
    
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={scv}

#####################################################################
# 	Macros
#####################################################################

[gcode_macro PRINT_START]
gcode:

    UPDATE_DELAYED_GCODE ID=DELAYED_FANS DURATION=0
    
    {% set BED_TEMP = params.BED_TEMP | default(60) | float %}	 											# Retrieve the bed temp from gcode
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP | default(200) | float %}									# Retrieve the extruder temp from gcode

    M106 S38
    
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={BED_TEMP}                            			 		# Start heating bed
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150                         					            # Set extruder pre heat temp
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={BED_TEMP}                                			  		# Wait for bed to reach target temp

    BED_MESH_CLEAR

    G28
    Z_TILT_ADJUST
    G28 Z
    BED_MESH_CALIBRATE
    CARTOGRAPHER_TOUCH

    G90
    SMART_PARK
    
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={EXTRUDER_TEMP}                         					# Set extruder temp
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={EXTRUDER_TEMP}                            				  	# Wait for extruder to reach target temp

    M106 S0
    
    SQUIGGLY_PURGE FLOWRATE=30
   
[gcode_macro PRINT_END]
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-10.0 F3600                ; retract filament
    G91                            ; relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    G1 Z2 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    G0  X162.5 Y330 F3600            ; park nozzle at rear
    BED_MESH_CLEAR
    M84

    M106 S38
    UPDATE_DELAYED_GCODE ID=DELAYED_FANS DURATION=3000

[delayed_gcode DELAYED_FANS]
initial_duration: 0
gcode:
    M107

[gcode_macro SQUIGGLY_PURGE]
gcode:
    # Mathematical constants
    {% set TAU = 6.28318 %}
    {% set PI = 3.14159 %}
    {% set FACTORIALS = [1, 2, 24, 720, 40320, 3628800, 479001600, 87178291200, 20922789888000] %}
    
    # Base macro parameters
    {% set prime_line_steps = params.STEPS|default(16)|int %}
    {% set prime_line_periods = params.PERIODS|default(10)|int %}
    {% set prime_line_amplitude = params.AMPLITUDE|default(5.0)|float %}
    {% set prime_line_period_length = params.PERIOD_LENGTH|default(5.0)|float %}
    {% set prime_line_purge_distance = params.PURGE_LENGTH|default(100.0)|float %}
    {% set prime_line_flowrate = params.FLOWRATE|default(10.0)|float %}
    {% set prime_line_height = params.LINE_HEIGHT|default(0.6)|float %}
    {% set prime_line_unretract_length = params.UNRETRACT_LENGTH|default(5.0)|float %}
    {% set prime_line_direction = params.LINE_DIRECTION|default("X")|string|upper %}
    {% set prime_line_margin = params.LINE_MARGIN|default(10.0)|float %} # Used only in adaptive mode
    {% set prime_line_adaptive = params.ADAPTIVE_MODE|default(1)|int %}
    {% set verbose = params.VERBOSE|default(1)|int %}

    # If the SIZE parameter is defined and not a dummy placeholder, we use it to do the adaptive bed mesh logic
    {% set coordinates_found = False %}
    {% if params.SIZE is defined and params.SIZE != "0_0_0_0" %}
        {% set xMinSpec, yMinSpec, xMaxSpec, yMaxSpec = params.SIZE.split('_')|map('trim')|map('int') %}
        {% set coordinates_found = True %}
    {% elif printer.exclude_object is defined %}
        {% if printer.exclude_object.objects %}
            # Else if SIZE is not defined, we fallback to use the [exclude_object] tags
            # This method is derived from Kyleisah KAMP repository: https://github.com/kyleisah/Klipper-Adaptive-Meshing-Purging)
            {% set eo_points = printer.exclude_object.objects|map(attribute='polygon')|sum(start=[]) %}
            {% set xMinSpec = eo_points|map(attribute=0)|min %}
            {% set yMinSpec = eo_points|map(attribute=1)|min %}
            {% set xMaxSpec = eo_points|map(attribute=0)|max %}
            {% set yMaxSpec = eo_points|map(attribute=1)|max %}
            {% set coordinates_found = True %}
        {% endif %}
    {% endif %}

    # We get the default prime line position parameters
    {% set prime_line_x = params.START_X|default(5.0)|float %}
    {% set prime_line_y = params.START_Y|default(3.5)|float %}
    {% set center_x, center_y = [printer.toolhead.axis_maximum.x / 2, printer.toolhead.axis_maximum.y / 2]|map("float") %}

    # Account for the amplitude (height) of the purge line
    {% if prime_line_direction == "X" %}
        {% set offset_x, offset_y = 0, prime_line_amplitude/2 %}
    {% else %}
        {% set offset_x, offset_y = prime_line_amplitude/2, 0 %}
    {% endif %}

    # If first layer coordinates are retrieved and adaptive mode is enabled, then we replace the coordinates to
    # do an adaptive purge while being careful to have the line stay on the bed when the first layer
    # is in an opposite bed quadrant than the prime line initial coordinates (due to mirrored coordinates from center axes)...
    {% if coordinates_found and prime_line_adaptive == 1 %}
        {% set prime_line_x = 2*center_x - prime_line_x if (prime_line_x > center_x and xMaxSpec < center_x) or (prime_line_x < center_x and xMinSpec > center_x) 
                               else prime_line_x %}
        {% set prime_line_y = 2*center_y - prime_line_y if (prime_line_y > center_y and yMaxSpec < center_y) or (prime_line_y < center_y and yMinSpec > center_y) 
                               else prime_line_y %}
        {% set prime_line_x = [[prime_line_x, xMinSpec - prime_line_margin - offset_x]|max, xMaxSpec + prime_line_margin + offset_x]|min %}
        {% set prime_line_y = [[prime_line_y, yMinSpec - prime_line_margin - offset_y]|max, yMaxSpec + prime_line_margin + offset_y]|min %}
    {% endif %}

    # Choose the way of printing the primeline (in + or -) alongside the direction to avoid going outside the bed boundaries
    {% set prime_line_way = -1 if (prime_line_direction == "X" and prime_line_x > center_x) or (prime_line_direction == "Y" and prime_line_y > center_y) else 1 %}

    # Calculate steps
    {% set steps = [] %}
    {% set state = namespace(cur_y=prime_line_y, prime_line_length=0.0, cos=0.0) %}

    {% for step in range(1, prime_line_periods * prime_line_steps + 1) %}
        {% set sign = cycler(1.0, -1.0) %}
        {% set state.cos = 0.0 %}
        {% set rad_angle = step / prime_line_steps * TAU %}
        {% for i in range(0, FACTORIALS|length) %}
            {% set cos_step = sign.next() * ((rad_angle%TAU)**(2*i) / FACTORIALS[i]) %}
            {% set state.cos = state.cos + cos_step %}
        {% endfor %}
        {% set dist_x = step * prime_line_period_length / prime_line_steps %}
        {% set dist_y = prime_line_amplitude * (0.5 - (0.5 * state.cos)) %}
        {% set rel_x = prime_line_period_length/prime_line_steps %}
        {% set rel_y = prime_line_y + dist_y - state.cur_y %}
        {% set e_length = (rel_x**2 + rel_y**2)**0.5 %}
        {% set state.cur_y = state.cur_y + rel_y %}
        {% set state.prime_line_length = state.prime_line_length + e_length %}
        {% set _ = steps.append((rel_x, rel_y, e_length)) %}
    {% endfor %}
    
    {% set max_extrude_cross_section = printer["configfile"].config["extruder"]["max_extrude_cross_section"]|float %}
    {% set filament_diameter = printer["configfile"].config["extruder"]["filament_diameter"]|float %}
    {% set filament_area = PI * (filament_diameter / 2)**2 %}
    
    # We first compute the width of the prime line
    {% set purge_volume = prime_line_purge_distance * filament_area %}
    {% set line_width = purge_volume / (prime_line_height * state.prime_line_length) %}

    # Then we check that the prime line cross section will not be problematic (exceeding Klipper max_extrude_cross_section)
    # or, if it's the case, we warn the user and add a correction to the length of filament to be purged
    {% if (prime_line_height * line_width) > max_extrude_cross_section %}
        {% if verbose %}
            {action_respond_info("The prime_line_purge_distance of %.4f mm is too high and will exceed the max_extrude_cross_section!" % prime_line_purge_distance)}
        {% endif %}
        {% set prime_line_purge_distance = 0.98 * (max_extrude_cross_section * state.prime_line_length) / filament_area %}
        {% set purge_volume = prime_line_purge_distance * filament_area %}
        {% set line_width = purge_volume / (prime_line_height * state.prime_line_length) %}
        {% if verbose %}
            {action_respond_info("Corrected the prime_line_purge_distance to %.4f mm" % prime_line_purge_distance)}
        {% endif %}
    {% endif %}

    # We then compute the height to width ratio and validate that the prime line will not be too thin
    {% if (prime_line_height / line_width) >= 0.5 %} # TODO: validate this 1/2 ratio is good for all
        {action_raise_error("The prime line will be too thin %.4f x %.4f and will probably not stick properly to the bed. Increase its purge distance or decrease its length!" % (prime_line_height, line_width))}
    {% endif %}

    # Finally we compute the speed to get the correct flowrate for the prime line
    {% set speed = (prime_line_flowrate / (prime_line_height * line_width)) * 60 |float %}

    G91
    M83
    {% if (printer.toolhead.position.z < 5) %}
        G1 Z5 F600
    {% endif %}

    # Starting position
    G90
    G0 X{prime_line_x} Y{prime_line_y} F18000

    # Add some extra squish to the prime line 
    G1 Z{prime_line_height*0.8} F600

    # Add pressure in the nozzle
    G92 E0
    G1 E{prime_line_unretract_length} F300

    # Prime line
    G92 E0
    G91
    {% if prime_line_direction == "X" %}
        {% for x,y,e in steps %}
            G1 X{x*prime_line_way} Y{y} E{e/state.prime_line_length*prime_line_purge_distance} F{speed}
        {% endfor %}
    {% elif prime_line_direction == "Y" %}
        {% for y,x,e in steps %}
            G1 X{x} Y{y*prime_line_way} E{e/state.prime_line_length*prime_line_purge_distance} F{speed}
        {% endfor %}
    {% else %}
        { action_respond_error("Prime line direction is not valid. Choose either X or Y in the variables.cfg file!") }
    {% endif %}
    G90
    
    # Retract and Z-hop
    G92 E0
    G1 E-0.2 F2100
    G92 E0
    G1 Z3 F600

    # Additional small movement to get out of the line as some slicers directly emmit
    # a Z- move as a first step that make the toolhead crash back in the line and get dirty
    G91
    G1 X5 Y5 F18000
    G90
    
    # Flushing Klipper's buffer to ensure the primeline sequence is done before continuing
    M400

[gcode_macro SMART_PARK]
description: Parks your printhead near the print area for pre-print hotend heating.
gcode:

    {% set z_height = params.HEIGHT | default(10) | float %}                                                                    # Set Z height variable
    {% set purge_margin = params.MARGIN | default(10) | float %}                                                                     # Set purge margin variable
    {% set verbose_enable = params.VERBOSE | default(True) | abs %}                                                                   # Set verbosity
    {% set center_x = printer.toolhead.axis_maximum.x / 2 | float %}                                                                # Create center point of x for fallback
    {% set center_y = printer.toolhead.axis_maximum.y / 2 | float %}                                                                # Create center point of y for fallback
    {% set axis_minimum_x = printer.toolhead.axis_minimum.x | float %}
    {% set axis_minimum_y = printer.toolhead.axis_minimum.y | float %}
    {% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}                                # Gather all object points
    {% set x_min = all_points | map(attribute=0) | min | default(center_x) %}                                                       # Set x_min from smallest object x point
    {% set y_min = all_points | map(attribute=1) | min | default(center_y) %}                                                       # Set y_min from smallest object y point
    {% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}                                                           # Set travel speed from config

    {% if purge_margin > 0 and x_min != center_x and y_min != center_y %}                                                           # If objects are detected and purge margin 
        {% set x_min = [ x_min - purge_margin , x_min ] | min %}                                                                    # value is greater than 0, move
        {% set y_min = [ y_min - purge_margin , y_min ] | min %}                                                                    # to purge location + margin
        {% set x_min = [ x_min , axis_minimum_x ] | max %}
        {% set y_min = [ y_min , axis_minimum_y ] | max %}
    {% endif %}

                                                                                                                                    # Verbose park location
    {% if verbose_enable == True %}

    { action_respond_info("Smart Park location: {},{}.".format(
        (x_min),
        (y_min),
    )) }

    {% endif %}
    
    SAVE_GCODE_STATE NAME=Presmartpark_State                                                                                        # Create gcode state

    G90                                                                                                                             # Absolute positioning
    {% if printer.toolhead.position.z < z_height %}
        G0 Z{z_height}                                                                                                              # Move Z to park height if current Z position is lower than z_height
    {% endif %}
    G0 X{x_min} Y{y_min} F{travel_speed}                                                                                            # Move near object area
    G0 Z{z_height}                                                                                                                  # Move Z to park height 

    RESTORE_GCODE_STATE NAME=Presmartpark_State                                                                                     # Restore gcode state

[gcode_macro ENABLE_MOTORS]
gcode:
  SET_STEPPER_ENABLE STEPPER=stepper_c ENABLE=1
  SET_STEPPER_ENABLE STEPPER=stepper_c1 ENABLE=1
  SET_STEPPER_ENABLE STEPPER=stepper_b ENABLE=1
  SET_STEPPER_ENABLE STEPPER=stepper_b1 ENABLE=1
  SET_STEPPER_ENABLE STEPPER=stepper_a ENABLE=1
  SET_STEPPER_ENABLE STEPPER=stepper_a1 ENABLE=1

[gcode_macro BELT_SHAPER]
gcode:
  TEST_RESONANCES AXIS=1,1 OUTPUT=raw_data
  TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data
    
[gcode_macro TEST_SPEED]
# Home, get position, throw around toolhead, home again.
# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# We only measure to a full step to accomodate for endstop variance.
# Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10

description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU

gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Minimum Cruise Ratio
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    # Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
    {% set bound = params.BOUND|default(20)|int %}
    # Size for small pattern box
    {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern
        # Max positions, inset by BOUND
        {% set x_min = printer.toolhead.axis_minimum.x + bound %}
        {% set x_max = printer.toolhead.axis_maximum.x - bound %}
        {% set y_min = printer.toolhead.axis_minimum.y + bound %}
        {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern at center
        # Find X/Y center point
        {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
        {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        
        # Set small pattern box around center point
        {% set x_center_min = x_center - (smallpatternsize/2) %}
        {% set x_center_max = x_center + (smallpatternsize/2) %}
        {% set y_center_min = y_center - (smallpatternsize/2) %}
        {% set y_center_max = y_center + (smallpatternsize/2) %}

    # Save current gcode state (absolute/relative, etc)
    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Output parameters to g-code terminal
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
    # Home and get position for comparison later:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28
        # QGL if not already QGLd (only if QGL section exists in config)
        {% if printer.configfile.settings.quad_gantry_level %}
            {% if printer.quad_gantry_level.applied == False %}
                QUAD_GANTRY_LEVEL
                G28 Z
            {% endif %}
        {% endif %} 
        # Move 50mm away from max position and home again (to help with hall effect endstop accuracy - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/24)
        G90
        G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 X Y
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Go to starting position
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    # Set new limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
    {% endif %}

    {% for i in range(iterations) %}
        # Large pattern diagonals
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        
        # Large pattern box
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
    
        # Small pattern diagonals
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
        # Small pattern box
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    # Restore max speed/accel/accel_to_decel to their configured values
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio} 
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    # Re-home and get position again for comparison:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 # This is a full G28 to fix an issue with CoreXZ - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/12
        # Go to XY home positions (in case your homing override leaves it elsewhere)
        G90
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Restore previous gcode state (absolute/relative, etc)
    RESTORE_GCODE_STATE NAME=TEST_SPEED

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 61.910
#*# pid_ki = 3.528
#*# pid_kd = 271.629
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 2500
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.055
#*#
#*# [scanner model default]
#*# model_coef = 1.4463834891874219,
#*# 	1.7769334573888111,
#*# 	0.7701148724274388,
#*# 	0.3535576061477769,
#*# 	0.384889610809115,
#*# 	0.4533053977625509,
#*# 	-0.17442462732344824,
#*# 	-0.3680817981082159,
#*# 	0.2226711047263861,
#*# 	0.23709916165895362
#*# model_domain = 3.1043762959342175e-07,3.27928108601412e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 24.637045
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.031546, 0.038342, 0.051674, 0.058235, 0.060475, 0.060883, 0.055687, 0.053623, 0.036130
#*# 	-0.053528, -0.025426, -0.009230, -0.008617, 0.000496, -0.008860, 0.000196, -0.002176, -0.008601
#*# 	-0.103589, -0.066846, -0.049178, -0.042246, -0.024839, -0.014310, -0.007864, -0.000921, -0.007800
#*# 	-0.133518, -0.090682, -0.074199, -0.062851, -0.049912, -0.026958, -0.010459, -0.015632, 0.000568
#*# 	-0.129628, -0.094030, -0.059541, -0.034424, -0.005644, 0.009473, 0.010552, 0.039765, 0.053581
#*# 	-0.121040, -0.077371, -0.045841, -0.027804, 0.005566, 0.028643, 0.042126, 0.052745, 0.082254
#*# 	-0.168868, -0.121827, -0.066014, -0.025826, -0.002371, 0.014154, 0.038196, 0.065118, 0.097449
#*# 	-0.171590, -0.116907, -0.091782, -0.030972, 0.011512, 0.039517, 0.068957, 0.083596, 0.122070
#*# 	-0.153802, -0.097721, -0.044068, -0.012394, 0.054535, 0.077213, 0.109046, 0.122115, 0.184553
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 10.0
#*# max_x = 290.0
#*# min_y = 30.0
#*# max_y = 305.0
#*#
#*# [telemetry]
#*# enabled = False
#*#
#*# [extruder]
#*# control = mpc
#*# block_heat_capacity = 36.3443
#*# sensor_responsiveness = 0.0947773
#*# ambient_transfer = 0.0831752
#*# fan_ambient_transfer = 0.0831752, 0.197098, 0.238055, 0.27032, 0.29538, 0.301485, 0.326232
